---
port: <%= if p("rabbitmq-server.management_tls.enabled") then 15691 else 15692 end %>
source_id: <%= if p('rabbitmq-server.cluster_name') == "" then 'rabbit@localhost' else p('rabbitmq-server.cluster_name') end %>
instance_id: <%= if p('rabbitmq-server.create_swap_delete') == true then "'rabbit@#{spec.address}'" else "'rabbit@#{Digest::MD5.hexdigest(spec.ip)}'" end %>
path: /metrics/detailed<%= p('rabbitmq-server.prom_scraper_detailed_endpoint_query') %>
scheme: <%= if p("rabbitmq-server.management_tls.enabled") then 'https' else 'http' end %>

<%
  server_name = 'localhost'

  if_link('rabbitmq-server-address') do |dns|
    server_name = dns.address
  end
%>
server_name: <%= server_name %>

<% if_p('rabbitmq-server.prom_scraper_labels') do |labels| %>
labels:
  <% labels.each do |key, value| %>
  <%= key %>: <%= value %>
  <% end %>
<% end %>

<% if_p("rabbitmq-server.management_tls.enabled") do %>
scrape:
  tls:
    ca_cert: <%= p("rabbitmq-server.management_tls.cacert", "").gsub("\n", "") %>
<% end %>
